<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Web Audio GUI</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="icon" type="image/png" href="svg/logo16.png" />

        <link rel="stylesheet" type="text/css" href="css/SheetMusic.css">
        <link rel="stylesheet" type="text/css" href="css/tabs.css">
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
        <link rel="stylesheet" href="css/synthUI2.css">            
        <style class="noteStyle"></style>
        <script src="js/MusicTools.js"></script>
        <script type='text/javascript' src='js/jquery/jquery-2.1.1.min.js'></script>
        <script src="js/math.min.js"></script>
        <script src='js/io.js'></script>
        <script src='js/InstrumentParams.js'></script>
        <script src='js/instrument2.js'></script>
        <script src='js/InstrumentNodeModels.js'></script>
        <script src="js/Scheduler.js"></script>
        <script src="js/SheetMusic.js"></script>
        <script src="js/chroma.min.js"></script>
        <script src='js/tabs.js'></script>
        <script src="js/synthUI3.js"></script>
        <script src="js/jsPlumb-1.7.10-min.js"></script>
        <script src="js/jquery-ui-position.min.js"></script>
        <style>
            p{
                max-width: 400px;
                padding-left: 15px;
                padding-right: 15px;
            }
        </style>
        <script>
            function Manager() {
                var audioContext = new AudioContext();
                var tabManager = new TabManager();
                var instrumentIo = new Io("instrument");
                var tabContainer = $(".tabContainer.main");
                function toast(msg){
                    $(".toastInner").text(msg);
                    $(".toastOverlay").show().fadeOut(2000);
                    
                }
                function makeMenu() {
                    var settingsDiv = $("<div>").addClass("settings");
                    var settingsIconSpan = $("<span>").addClass("settingsIcon").appendTo(settingsDiv);
                    $("<i>").addClass("fa fa-cog fa-lg").appendTo(settingsIconSpan);
                    var menuContent = $("<div>").addClass("settingsDiv").appendTo(settingsDiv);
                    settingsIconSpan.click(function() {
                        settingsDiv.addClass("active");
                        menuContent.position({
                            my: "left top",
                            at: "left bottom;",
                            of: settingsIconSpan
                        });
                        var rect = menuContent[0].getBoundingClientRect();
                        var winRect = $(this).closest(".tabContainer")[0].getBoundingClientRect();
                        var menuTop = rect.top - winRect.top;
                        var maxHeight = winRect.height - menuTop - 25;
                        menuContent.css("max-height", maxHeight+"px");
                        if(maxHeight<rect.height){
                            var moreIndicator = $("<div>")
                                    .addClass("menuMoreIndicator")
                                    .html("&#9660;")
                                    .width(menuContent.width())
                                    .appendTo(menuContent)
                                    .css({left:rect.left, top: (maxHeight+rect.top+5)})
                            
                        }
                        console.log(rect, winRect, maxHeight);
                        
                        $(".settingsOverlay").show();
                    });
                    return settingsDiv;
                }
                function newTab(label) {
                    var tabId = tabManager.newTab(tabContainer, label);
                    var tabHeader = $(".tabHeader[data-tab-id=" + tabId + "]");
                    makeMenu().appendTo(tabHeader);
                    return tabId;
                }


                /*
                 * activeInstrumentInstances:
                 * keys are instrumentTypeNames;
                 * values are arrays of instruments;
                 * these arrays are master lists.  They will be passed to 
                 * synthUi's as they are created.
                 */
                var activeInstrumentInstances = {};
                /*
                 * guiOpenInstrumentTypes:
                 * keys are instrumentTypeNames
                 * values {tabId: xxx, synthUi:xxx}
                 * 
                 */
                var instrumentTypeEditors = {};
                function getNewInstrumentName() {
                    return prompt("Please name your new instrument.");
                }
                function newInstrumentInstance(typeName, forEditor) {
                    /*
                     * make an instrument instance.  Add it to activeInstrumentInstances.
                     * if(guiOpenInstrumentTypes[typeName]) 
                     * return instrumentInstanceId?
                     */
                    var instrument;
                    if (typeName) {
                        var serializedInstr = instrumentIo.getItem(typeName);
                        if (serializedInstr) {
                            instrument = new Instrument(audioContext, serializedInstr);
                        }
                    }
                    if (!instrument) {
                        instrument = new Instrument(audioContext);
                        typeName = instrumentIo.saveAs(instrument.serialize());
                        if(!typeName){
                            return;
                        }
                    }
                    var group;
                    if (!activeInstrumentInstances[typeName]) {
                        activeInstrumentInstances[typeName] = [];
                    }
                    group = activeInstrumentInstances[typeName];
                    if (forEditor) {
                        group.unshift(instrument);
                    } else {
                        group.push(instrument);
                    }
                    instrument.name = typeName
                    return instrument;
                }
                function closeInstrumentInstance(instrument) {
                    instrument.kill();
                    var group = activeInstrumentInstances[instrument.name];
                    var index = group.indexOf(instrument);
                    group.splice(index, 1);
                }
                function openInstrumentEditor(typeName) {
                    if (instrumentTypeEditors[typeName]) {  //editor already open
                        var editor = instrumentTypeEditors[typeName];
                        tabManager.activate(tabContainer, editor.tabId);
                    } else {
                        var instrument = newInstrumentInstance(typeName, true);
                        if(!instrument){
                            return;
                        }
                        typeName = instrument.name;
                        var tabId = newTab(typeName);
                        var settingsDiv = $(".tabHeader[data-tab-id=" + tabId + "]").find(".settingsDiv");
                        $("<div>").addClass("nodeMaker").attr("data-tab-id", tabId).appendTo(settingsDiv);
                        $("<div>").addClass("menuSpacer").appendTo(settingsDiv);
                        $("<div>")
                                .addClass("saveInstrumentBtn menuItem")
                                .text("Save Instrument")
                                .attr({
                                    "data-instrName": typeName
                                }).appendTo(settingsDiv).click(function(){
                                    var name = $(this).attr("data-instrName");
                                    saveInstrumentType(name);
                                });
                        $("<div>")
                                .addClass("saveInstrumentAsBtn menuItem")
                                .text("Save Instrument As...")
                                .attr({
                                    "data-instrName": typeName
                                }).appendTo(settingsDiv).click(function(){
                                    var name = $(this).attr("data-instrName");
                                    saveInstrumentTypeAs(name);
                                });
                        $("<div>")
                                .addClass("closeInstrumentEditorBtn menuItem")
                                .text("Close")
                                .attr({
                                    "data-instrName": typeName
                                }).appendTo(settingsDiv).click(function(){
                                    var name = $(this).attr("data-instrName");
                                    closeInstrumentEditor(name);
                                });
                        $("<div>")
                                .addClass("deleteInstrumentType menuItem")
                                .text("Delete Instrument")
                                .attr({
                                    "data-instrName": typeName
                                }).appendTo(settingsDiv).click(function(){
                                    var name = $(this).attr("data-instrName");
                                    deleteInstrumentType(name);
                                });
                                
                    }
                    var instruments = activeInstrumentInstances[typeName];
                    var synthUi = new SynthUi($(".tabBody[data-tab-id=" + tabId + "]"), $(".nodeMaker[data-tab-id=" + tabId + "]"), instruments);
                    instrumentTypeEditors[typeName] = {
                        tabId: tabId,
                        synthUi: synthUi
                    }
                    return tabId
                }
                
                function closeInstrumentEditor(typeName) {
                    var editor = instrumentTypeEditors[typeName];
                    var instruments = activeInstrumentInstances[typeName];
                    closeInstrumentInstance(instruments[0]);
                    tabManager.removeTab(tabContainer, editor.tabId);
                    delete instrumentTypeEditors[typeName];
                }
                function deleteInstrumentType(typeName) {
                    var doIt = instrumentIo.deleteItem(typeName, " Projects that rely on " + typeName + " may malfunction.");
                    if(doIt){closeInstrumentEditor(typeName);
                        var group = activeInstrumentInstances[typeName];
                        for (var i = 0; i < group; i++) {
                            group[i].kill();
                        }
                        delete activeInstrumentInstances[typeName];
                    }
                }
                function saveInstrumentType(typeName){
                    var serialized = activeInstrumentInstances[typeName][0].serialize();
                    var savedName = instrumentIo.saveItem(typeName, serialized);
                    if(savedName){
                        toast(savedName + " saved successfully.");
                    }else{
                        toast(typeName + " failed to save.");
                    }
                }
                function saveInstrumentTypeAs(oldTypeName){
                    var serialized = activeInstrumentInstances[oldTypeName][0].serialize();
                    var savedName = instrumentIo.saveAs(serialized);
                    if(savedName){
                        toast(savedName + " saved successfully.");
                    }
                }
                
                function makeControls() {
                    var tabHeaderControls = $(".headerBarControls");
                    makeMenu().appendTo(tabHeaderControls);
                    var settingsDiv = tabHeaderControls.find(".settingsDiv");
                    
                    //load item select box
                    var selectDiv = $("<div>").addClass("menuItem").appendTo(settingsDiv);
                    $("<label>").text("Open: ").appendTo(selectDiv);
                    var select = $("<select>").appendTo(selectDiv);
                    instrumentIo.setupOpenSelect(select, function(typeName) {
                        openInstrumentEditor(typeName);
                        $(".settingsOverlay").click();
                    });
                    instrumentIo.refreshNames();
                    //new instrument btn
                    var newInstrBtn = $("<div>").addClass("newInstrBtn menuItem").text("New Instrument").appendTo(settingsDiv);
                    newInstrBtn.on("click", function() {
                        openInstrumentEditor();
                        $(".settingsOverlay").click();
                    })

                    /* var showMenu = function(e){
                     $(this).parents(".settings").addClass("active");
                     $(".settingsOverlay").show();
                     }
                     $(".settingsIcon").click(showMenu);
                     //$("body").on("click", ".settingsIcon", showMenu)*/
                    $(".settingsOverlay").click(function() {
                        $(".settings.active").removeClass("active");
                        $(".settingsOverlay").hide();
                        $(".menuMoreIndicator").remove();
                    })
                    $(".settings").on("click", function(e) {
                        e.stopPropagation();
                    })
                }
                makeControls();
                function tooltipSetup() {
                    $("body").on("mouseenter", "[data-hint]", function() {
                        var hint = $(this).attr("data-hint");
                        var tooltipId = $(this).attr("data-tooltipid");
                        if (!tooltipId) {
                            tooltipId = Math.random().toString(32).substr(2);
                            $(this).attr("data-tooltipid", tooltipId);
                        }
                        var tooltip = $("<div>").addClass("tooltip").attr("data-tooltipid", tooltipId).html(hint).appendTo("body");
                        tooltip.position({
                            my: "left top",
                            at: "right+15px top",
                            of: $(this)
                        });
                    })
                    $("body").on("mouseleave", "[data-hint]", function() {
                        var tooltipId = $(this).attr("data-tooltipid");
                        $(".tooltip[data-tooltipid=" + tooltipId + "]").remove();
                    })
                }
                tooltipSetup();
            }

            $(function() {
                new Manager();
            })
        </script>
    </head>
    <body>

        <div class='tabContainer main'>
            <div class="tabHeaderBar">
                
                <div class='tabHeaders' data-leftstart="0" data-rightend="36px">
                    <div class='tabHeader active' data-tabfor='1' style='padding-left:5px;padding-right:5px;'>Hi</div>
                </div>
                <div class='headerBarControls'>
                    <!--<i class="fa newMusicSheet">New Music Sheet</i>
                    <i class="fa newInstrument">New Instrument</i>
                    <i class="rmTab">Rm Tab</i>
                    <i id="toBeginning" class="schedulerControl fa fa-fast-backward"></i>
                    <i id="back" class="schedulerControl fa fa-step-backward"></i>
                    <i id="play" class="schedulerControl fa fa-play"></i>
                    <i id="pause" class="schedulerControl fa fa-pause"></i>
                    <i id="forward" class="schedulerControl fa fa-step-forward"></i>
                    <span class="schedulerControl logNodes">Log nodes</span>
                    <span class="schedulerControl logInstruments">Log Instrument Info</span>-->
                </div>
            </div>

            <div class='tabBodies'>
                <div class='tabBody introduction' data-tab='1' style='overflow:scroll;'>
                    <p>Hello, and welcome.  This is a work in progress.  The goal 
                        is to to have a flexible GUI for building patches with the 
                        Web Audio API.  Much of it works already.</p>
                    <p>To get started, click the gear icon on the right and then 
                        choose a example to look at from the drop down box.  The example patch,
                       or instrument, will open in a new tab.  You can play with the settings, 
                       add new nodes from that tab's settings menu, delete nodes, etc.
                       You will see an interface at the bottom for playing notes on 
                       the instrument.</p>
                    <p>You can also make new patches for yourself by selecting New
                        Instrument from the main gear menu on the right.  You can save
                        your instruments for later use.  They will be saved in local
                        storage in the browser. <small>I haven't figured out a way to 
                            get BufferSources or Convolvers to save, but I'll get there</small>
                    
                </div>
                    
            </div>

        </div>
        <div class='settingsOverlay'></div>
        <div class="toastOverlay"><div class="toastInner"></div></div>
    </body>
</html>

<!--
for MusicSheet
<div class='footer' data-tab='1'>
    <span>Zoom: <input id="scaleRange" type="range" min="0.1" max="3" step="0.1" value="1"></span>
    <span>Note Spacing: <input id="spacingRange" type="range" min="10" max="500" value="100" step="10"></span>
</div>
//Sheet music scaling setup
function rescale() {
    var scale = $("#scaleRange").val();
    var spacing = $("#spacingRange").val();
    $("#scaleRange").next().text(scale);
    $("#spacingRange").next().text(spacing);
    musicSheet.rescale(scale, spacing);
}
$("#scaleRange,#spacingRange").on("change input", rescale)
rescale();



for SynthUI
<div class='footer' data-tab='2'>
    <span>Zoom: <input id="zoom" type="range" min="0.25" max="1" step="0.25" value="1"></span>
</div>
//synthUi scaling setup
$("#zoom").on("input", function() {
    var zoom = $(this).val();
    $("#plumbing").css("transform", "scale(" + zoom + ")");
    jsPlumb.setZoom(zoom);
    //$(".plumbNode").css("border",(1.49/zoom)+"px solid black");
});





<div id='miscSheetMusic'>
    <div id="newSongOverlay">
        <div id="newSongDialog">
            <div><label for="trebleInput">Treble Clef Voices</label><input id="trebleInput" type="number" value="2"></div>
            <div><label for="altoInput">Alto Clef Voices</label><input id="altoInput" type="number"></div>
            <div><label for="bassInput">Bass Clef Voices</label><input id="bassInput" type="number" value="2"></div>
            <div><label for="keySelect">Key</label>
                <select id="keySelect">
                    <option value="C">C (0 sharps, 0 flats)</option><option value="G">G (1 sharp)</option><option value="D">D (2 sharps)</option><option value="A">A (3 sharps)</option><option value="E">E (4 sharps)</option><option value="B">B (5 sharps)</option><option value="F#">F# (6 sharps)</option><option value="C#">C# (7 sharps)</option><option value="Cb">Cb (7 flats)</option><option value="Gb">Gb (6 flats)</option><option value="Db">Db (5 flats)</option><option value="Ab">Ab (4 flats)</option><option value="Eb">Eb (3 flats)</option><option value="Bb">Bb (2 flats)</option><option value="F">F (1 flat)</option>
                </select>
            </div>
            <button id="newSongOk">Ok</button><button id="newSongCancel">Cancel</button>
        </div>
    </div>
    <div id="help">
        <p>Mostly it's just type it in.  Up arrow for higher, down for lower, right for longer, left for shorter.  &gt; for sharp, &lt; for flat</p>
        <h3>Key Signature</h3>
        <p>You can change the key signature measure by measure.  To change the key signature in a measure click on it (it's there even if you can't see it, just click around at the beginning of the measure until an you get an empty selection box).
            Left and right arrow keys change the key signature once it's selected.  </p>
        <p>If you want the key signature for one bar to apply to all following bars, double click it</p>

    </div>

</div>
function rangeDisplay() {
    $(this).parent().attr("data-hint", $(this).val())
}
$("body").on("mouseover input", "input[type=range]", rangeDisplay);

-->